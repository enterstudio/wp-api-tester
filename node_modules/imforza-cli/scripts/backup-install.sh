#!/bin/sh
# Local Development Setup Script
# https://gist.github.com/bhubbard/d526710ba26477116353

echo "---"
echo "Setup Local with WP Engine Backup"
echo "by imFORZA"
echo "---"
echo "- Script Requirements:"
echo "- WP-CLI (https://wp-cli.org)"
echo "- Local by Flywheel (https://local.getflywheel.com)"
echo "---\n"


printf "What is the local dev url? (example: localdomain.dev)?"
read DEVURL

printf "What is the live site url? (example: example.com)?"
read LIVEURL

printf "Please provide the url to the backup file (provided by WP Engine)?"
read BACKUPURL


# ----- Start Setup ------- #

# apt-get update
# apt-get install php5-curl php5-cli git subversion wget unzip

wget $BACKUPURL

# Unzip Backup
unzip site-archive-* -d backup

# Remove default files
rm -rf /app/public/wp-content/themes
rm -rf /app/public/wp-content/plugins
rm -rf /app/public/wp-content/uploads

# Move PLUGINS, THEMES, UPLOADS
cd backup
mv wp-content/themes /app/public/wp-content/themes
mv wp-content/plugins /app/public/wp-content/plugins
mv wp-content/uploads /app/public/wp-content/uploads

# IMPORT DB
wp db import wp-content/mysql.sql

# Perform search/replace with wp-cli
wp search-replace '$LIVEURL' '$DEVURL'

cd ..

# Run Cleanup, remove ZIP File, and unzipped folder.
rm -rf site-archive-*
rm -rf backup

# Finished Confirmation
printf "Your new local site $DEVURL is now setup."